<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventas 2024 - 2025</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (Pinned Versions for Stability) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Prop-Types (Required dependency for Recharts UMD) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    
    <!-- Recharts (Pinned Version) -->
    <script src="https://unpkg.com/recharts@2.12.3/umd/Recharts.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }

        /* PDF Generation Classes */
        .pdf-mode {
            width: 1200px !important;
            min-height: 100vh !important;
            overflow: visible !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 9999 !important;
            background: #f8fafc !important; /* bg-slate-50 */
            padding: 40px !important;
        }
        
        /* Force single column for PDF blocks to ensure they fit nicely */
        .pdf-mode .grid {
            display: grid !important; 
        }
        
        /* Hide elements during PDF generation */
        .hide-on-pdf {
            display: none !important;
        }

        /* Page Break Helper */
        .page-break {
            page-break-before: always;
            margin-top: 40px;
            border-top: 2px dashed #cbd5e1;
            padding-top: 40px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { 
            LineChart, Line, BarChart, Bar, AreaChart, Area, XAxis, YAxis, 
            CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell, ComposedChart 
        } = window.Recharts || {};

        // --- TRANSLATIONS ---
        const TRANSLATIONS = {
            es: {
                title: "Ventas 2024 - 2025",
                subtitle: "Análisis de venta y márgenes",
                footer: "SSC GOURMET DISTRIBUTION",
                sourceInfo: "Información combinada de Odoo y Apsheet",
                tabs: {
                    dashboard: "Dashboard General",
                    growth: "Crecimiento General",
                    margin: "Margen & Rentabilidad"
                },
                kpis: {
                    totalRevenue: "Facturación Total",
                    totalKg: "KG Totales Entregados",
                    avgMargin: "Margen Promedio por KG",
                    totalProfit: "Beneficio Total",
                    growthRevenue: "Crecimiento Facturación",
                    growthVol: "Crecimiento Volumen (KG)",
                    marginPct: "% de Margen Global",
                    marginGap: "Diferencia vs 2024"
                },
                charts: {
                    monthlyRevenue: "Facturación Mensual Comparativa",
                    topClients: "Top 5 Clientes",
                    topRecipes: "Top 5 Recetas (Volumen KG)",
                    monthlyComp: "Comparativa Mensual",
                    quarterly: "Crecimiento Trimestral",
                    volEvolution: "Evolución Volumen (KG)",
                    recipeDist: "Distribución por Receta",
                    priceVsCost: "Evolución Precio vs Costo (Promedios Ponderados)",
                    profitComp: "Composición Beneficio vs Costo",
                    recipeProfit: "Rentabilidad por Receta"
                },
                table: {
                    client: "Cliente",
                    sale: "Venta",
                    growth: "Crecimiento",
                    q: "Trimestre",
                    change: "Cambio",
                    concept: "Concepto",
                    price: "Precio Prom/KG",
                    cost: "Costo Prom/KG",
                    margin: "Margen/KG",
                    marginPct: "% Margen",
                    recipe: "Receta",
                    profit: "Beneficio Total"
                },
                obs: {
                    general: "Observaciones Generales",
                    growth: "Análisis de Crecimiento",
                    margin: "Análisis de Rentabilidad"
                },
                common: {
                    downloadPdf: "Descargar Vista Actual",
                    downloadFull: "Descargar Informe Completo",
                    loading: "Cargando datos...",
                    error: "Error cargando datos",
                    year: "Año",
                    price: "Precio",
                    cost: "Costo",
                    margin: "Margen",
                    profit: "Beneficio",
                    vs: "vs",
                    generating: "Generando PDF..."
                }
            },
            fr: {
                title: "Ventes 2024 - 2025",
                subtitle: "Analyse des ventes et des marges",
                footer: "SSC GOURMET DISTRIBUTION",
                sourceInfo: "Informations combinées d'Odoo et Apsheet",
                tabs: {
                    dashboard: "Tableau de Bord",
                    growth: "Croissance Générale",
                    margin: "Marge & Rentabilité"
                },
                kpis: {
                    totalRevenue: "Chiffre d'Affaires Total",
                    totalKg: "KG Totaux Livrés",
                    avgMargin: "Marge Moyenne par KG",
                    totalProfit: "Bénéfice Total",
                    growthRevenue: "Croissance CA",
                    growthVol: "Croissance Volume (KG)",
                    marginPct: "% Marge Globale",
                    marginGap: "Écart vs 2024"
                },
                charts: {
                    monthlyRevenue: "Revenus Mensuels Comparatifs",
                    topClients: "Top 5 Clients",
                    topRecipes: "Top 5 Recettes (Volume KG)",
                    monthlyComp: "Comparaison Mensuelle",
                    quarterly: "Croissance Trimestrielle",
                    volEvolution: "Évolution du Volume (KG)",
                    recipeDist: "Répartition par Recette",
                    priceVsCost: "Évolution Prix vs Coût (Moyennes Pondérées)",
                    profitComp: "Composition Bénéfice vs Coût",
                    recipeProfit: "Rentabilité par Recette"
                },
                table: {
                    client: "Client",
                    sale: "Vente",
                    growth: "Croissance",
                    q: "Trimestre",
                    change: "Chang.",
                    concept: "Concept",
                    price: "Prix Moy/KG",
                    cost: "Coût Moy/KG",
                    margin: "Marge/KG",
                    marginPct: "% Marge",
                    recipe: "Recette",
                    profit: "Bénéfice Total"
                },
                obs: {
                    general: "Observations Générales",
                    growth: "Analyse de la Croissance",
                    margin: "Analyse de Rentabilité"
                },
                common: {
                    downloadPdf: "Télécharger la Vue Actuelle",
                    downloadFull: "Télécharger le Rapport Complet",
                    loading: "Chargement des données...",
                    error: "Erreur de chargement",
                    year: "Année",
                    price: "Prix",
                    cost: "Coût",
                    margin: "Marge",
                    profit: "Bénéfice",
                    vs: "vs",
                    generating: "Génération du PDF..."
                }
            }
        };

        // --- ICONS ---
        const Icon = ({ name, className }) => {
            // Simplified SVG paths for better rendering
            const icons = {
                dollar: <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />,
                scale: <g><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" strokeLinejoin="round"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" strokeLinejoin="round"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></g>,
                trendingUp: <g><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></g>,
                chart: <g><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></g>,
                pie: <g><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></g>,
                download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></g>,
                fileText: <g><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></g>,
                dashboard: <g><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></g>,
                loader: <path d="M21 12a9 9 0 1 1-6.219-8.56"/>,
                globe: <g><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></g>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || icons.dollar}
                </svg>
            );
        };

        // --- CONSTANTS ---
        const API_URL = "https://script.google.com/macros/s/AKfycbxSFMjSZqI8bf_bgMnm_mAZHAKaeQGhMfW-ejl8pM7fAQ-FSE_IIefuIak_LUJ1pdQmXw/exec";
        const COLORS = {
            year2024: "#4169E1",
            year2024Light: "#93c5fd",
            year2025: "#9333EA",
            year2025Light: "#d8b4fe",
            positive: "#10b981",
            negative: "#ef4444",
            grid: "#e2e8f0"
        };
        const RECIPE_COLORS = ["#8884d8", "#82ca9d", "#ffc658", "#ff8042", "#0088FE", "#00C49F"];
        const MONTHS = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

        // --- UTILS ---
        const formatCurrency = (val, lang = 'es') => new Intl.NumberFormat(lang === 'es' ? 'es-MX' : 'fr-FR', { style: 'currency', currency: 'MXN' }).format(val);
        const formatNumber = (val, lang = 'es') => new Intl.NumberFormat(lang === 'es' ? 'es-MX' : 'fr-FR').format(val);
        
        const parseDate = (dateStr) => {
            if (!dateStr) return new Date();
            let s = String(dateStr);
            if (s.includes('T')) s = s.split('T')[0];
            const parts = s.split('-');
            if (parts.length === 3) return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            return new Date(dateStr);
        };

        // --- COMPONENTS ---
        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [processedData, setProcessedData] = useState(null);
            const [lang, setLang] = useState('es');
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            const contentRef = useRef(null);
            const fullReportRef = useRef(null);

            // Language Detection
            useEffect(() => {
                const browserLang = navigator.language || navigator.userLanguage;
                if (browserLang.startsWith('fr')) setLang('fr');
                else setLang('es');
            }, []);

            const t = TRANSLATIONS[lang];

            useEffect(() => {
                fetch(API_URL)
                    .then(res => res.json())
                    .then(jsonData => {
                        let finalData = [];
                        if (Array.isArray(jsonData)) finalData = jsonData;
                        else if (jsonData && Array.isArray(jsonData.data)) finalData = jsonData.data;
                        else if (jsonData && Array.isArray(jsonData.items)) finalData = jsonData.items;
                        else throw new Error("Formato inválido");
                        
                        // Normalize
                        const normalizedData = finalData.map(item => {
                            const newItem = {};
                            Object.keys(item).forEach(key => {
                                const cleanKey = key.toLowerCase().trim().replace(/\s+/g, '_');
                                newItem[cleanKey] = item[key];
                            });
                            return newItem;
                        });

                        setData(normalizedData);
                        processAllData(normalizedData);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(t.common.error);
                        setLoading(false);
                    });
            }, [lang]); 

            const processAllData = (rawData) => {
                const monthlyData = Array(12).fill(0).map((_, i) => ({
                    name: MONTHS[i],
                    monthIndex: i,
                    sales2024: 0, sales2025: 0,
                    kg2024: 0, kg2025: 0,
                    cost2024: 0, cost2025: 0,
                    profit2024: 0, profit2025: 0
                }));

                const clients = {};
                const recipes = {};
                let totals = {
                    sales2024: 0, sales2025: 0,
                    kg2024: 0, kg2025: 0,
                    profit2024: 0, profit2025: 0,
                };

                rawData.forEach(item => {
                    const date = parseDate(item.invoice_date);
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    
                    const parseNum = (val) => {
                        if (typeof val === 'number') return val;
                        if (!val) return 0;
                        const cleanStr = String(val).replace(/[$,]/g, '');
                        const num = parseFloat(cleanStr);
                        return isNaN(num) ? 0 : num;
                    };

                    const sale = parseNum(item.item_sale);
                    const kg = parseNum(item.item_coffee_weight_sum);
                    const totalCost = parseNum(item.coffee_total_cost);
                    const profit = sale - totalCost;
                    
                    const clientId = item.client_fiscal_id || "Desconocido";
                    const recipeId = item.item_recipe || "Generico";

                    if (!clients[clientId]) clients[clientId] = { name: clientId, sales2024: 0, sales2025: 0 };
                    if (!recipes[recipeId]) recipes[recipeId] = { name: recipeId, kg2024: 0, kg2025: 0, profit2025: 0, sales2025: 0 };

                    if (year === 2024) {
                        monthlyData[month].sales2024 += sale;
                        monthlyData[month].kg2024 += kg;
                        monthlyData[month].cost2024 += totalCost;
                        monthlyData[month].profit2024 += profit;
                        totals.sales2024 += sale;
                        totals.kg2024 += kg;
                        totals.profit2024 += profit;
                        clients[clientId].sales2024 += sale;
                        recipes[recipeId].kg2024 += kg;
                    } else if (year === 2025) {
                        monthlyData[month].sales2025 += sale;
                        monthlyData[month].kg2025 += kg;
                        monthlyData[month].cost2025 += totalCost;
                        monthlyData[month].profit2025 += profit;
                        totals.sales2025 += sale;
                        totals.kg2025 += kg;
                        totals.profit2025 += profit;
                        clients[clientId].sales2025 += sale;
                        recipes[recipeId].kg2025 += kg;
                        recipes[recipeId].profit2025 += profit;
                        recipes[recipeId].sales2025 += sale;
                    }
                });

                monthlyData.forEach(m => {
                    m.avgPrice2024 = m.kg2024 > 0 ? m.sales2024 / m.kg2024 : 0;
                    m.avgCost2024 = m.kg2024 > 0 ? m.cost2024 / m.kg2024 : 0;
                    m.avgPrice2025 = m.kg2025 > 0 ? m.sales2025 / m.kg2025 : 0;
                    m.avgCost2025 = m.kg2025 > 0 ? m.cost2025 / m.kg2025 : 0;
                });

                totals.avgMarginPerKg2024 = totals.kg2024 > 0 ? totals.profit2024 / totals.kg2024 : 0;
                totals.avgMarginPerKg2025 = totals.kg2025 > 0 ? totals.profit2025 / totals.kg2025 : 0;
                totals.marginPct2024 = totals.sales2024 > 0 ? (totals.profit2024 / totals.sales2024) * 100 : 0;
                totals.marginPct2025 = totals.sales2025 > 0 ? (totals.profit2025 / totals.sales2025) * 100 : 0;

                setProcessedData({
                    monthly: monthlyData,
                    clients: Object.values(clients).sort((a,b) => b.sales2025 - a.sales2025),
                    recipes: Object.values(recipes).sort((a,b) => b.kg2025 - a.kg2025),
                    totals: totals
                });
            };

            const generatePdfFromElement = async (element, filename) => {
                try {
                    // Temporarily force width for consistency during capture
                    const originalWidth = element.style.width;
                    element.style.width = '1200px'; 

                    const canvas = await html2canvas(element, {
                        scale: 1.5,
                        useCORS: true,
                        logging: false,
                        windowWidth: 1200,
                        backgroundColor: '#f8fafc' // bg-slate-50
                    });

                    // Restore width
                    element.style.width = originalWidth;

                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF({
                        orientation: 'portrait',
                        unit: 'pt',
                        format: 'letter'
                    });

                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    const pageHeight = pdf.internal.pageSize.getHeight();

                    let heightLeft = pdfHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - pdfHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(filename);
                } catch (e) {
                    console.error("PDF Error", e);
                    alert("Error generando PDF");
                }
            };

            // Download Current View (Existing)
            const handleDownloadCurrentView = async () => {
                if (!contentRef.current) return;
                const element = contentRef.current;
                element.classList.add('pdf-mode');
                await new Promise(resolve => setTimeout(resolve, 500)); // Short wait
                await generatePdfFromElement(element, `Report_${activeTab}.pdf`);
                element.classList.remove('pdf-mode');
            };

            // Download Full Report (New)
            const handleDownloadFullReport = async () => {
                setIsGeneratingPdf(true);
                // Wait for state update and rendering of the full report container
                await new Promise(resolve => setTimeout(resolve, 2500)); // Longer wait for 3 sections to render
                
                if (fullReportRef.current) {
                    await generatePdfFromElement(fullReportRef.current, `Informe_Completo_Ventas.pdf`);
                }
                
                setIsGeneratingPdf(false);
            };

            const toggleLang = () => {
                setLang(prev => prev === 'es' ? 'fr' : 'es');
            };

            if (loading) return (
                <div className="flex h-screen items-center justify-center bg-gray-50">
                    <div className="text-center">
                        <Icon name="loader" className="w-12 h-12 text-blue-600 animate-spin mx-auto mb-4" />
                        <h2 className="text-xl font-semibold text-gray-700">Loading...</h2>
                    </div>
                </div>
            );

            if (error || !processedData) return <div className="p-10 text-red-600 text-center">{error}</div>;

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* Sidebar */}
                    <aside className="w-64 bg-slate-900 text-white flex flex-col shadow-xl z-20 hidden md:flex">
                        <div className="p-6 border-b border-slate-800">
                            <h1 className="text-xl font-bold tracking-tight text-blue-400 uppercase leading-tight">{t.title}</h1>
                            <p className="text-xs text-slate-400 mt-2">{t.subtitle}</p>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <NavButton id="dashboard" label={t.tabs.dashboard} icon="dashboard" active={activeTab} set={setActiveTab} />
                            <NavButton id="growth" label={t.tabs.growth} icon="trendingUp" active={activeTab} set={setActiveTab} />
                            <NavButton id="margin" label={t.tabs.margin} icon="dollar" active={activeTab} set={setActiveTab} />
                        </nav>
                        
                        <div className="p-4 border-t border-slate-800">
                            <button onClick={toggleLang} className="flex items-center gap-2 text-sm text-slate-400 hover:text-white w-full px-2 py-2 rounded hover:bg-slate-800 transition-colors">
                                <Icon name="globe" className="w-4 h-4" />
                                <span>{lang === 'es' ? 'Cambiar a Francés (FR)' : 'Passer en Espagnol (MX)'}</span>
                            </button>
                        </div>
                        <div className="p-4 border-t border-slate-800 text-[10px] text-slate-500 text-center font-bold tracking-wider">
                            {t.footer}
                        </div>
                    </aside>

                    {/* Mobile Header */}
                    <div className="md:hidden fixed top-0 w-full bg-slate-900 text-white z-30 p-4 flex justify-between items-center shadow-md">
                        <span className="font-bold">{t.title}</span>
                        <div className="flex gap-2">
                             <button onClick={toggleLang} className="text-xs bg-slate-800 px-2 py-1 rounded">
                                {lang.toUpperCase()}
                            </button>
                        </div>
                    </div>

                    {/* Mobile Tabs */}
                    <div className="md:hidden fixed bottom-0 w-full bg-white border-t border-gray-200 z-30 flex justify-around p-2">
                         <button onClick={() => setActiveTab('dashboard')} className={`p-2 rounded-full ${activeTab === 'dashboard' ? 'bg-blue-100 text-blue-600' : 'text-gray-500'}`}><Icon name="dashboard" className="w-6 h-6"/></button>
                         <button onClick={() => setActiveTab('growth')} className={`p-2 rounded-full ${activeTab === 'growth' ? 'bg-blue-100 text-blue-600' : 'text-gray-500'}`}><Icon name="trendingUp" className="w-6 h-6"/></button>
                         <button onClick={() => setActiveTab('margin')} className={`p-2 rounded-full ${activeTab === 'margin' ? 'bg-blue-100 text-blue-600' : 'text-gray-500'}`}><Icon name="dollar" className="w-6 h-6"/></button>
                    </div>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto bg-gray-50 relative pt-16 md:pt-0 pb-16 md:pb-0" ref={contentRef}>
                        <div className="max-w-7xl mx-auto p-4 md:p-8">
                            {/* Header */}
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                                <div>
                                    <h2 className="text-2xl md:text-3xl font-bold text-slate-800">
                                        {t.tabs[activeTab]}
                                    </h2>
                                    <p className="text-slate-500 mt-1 text-sm">{t.sourceInfo}</p>
                                </div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={handleDownloadFullReport}
                                        disabled={isGeneratingPdf}
                                        className="hide-on-pdf flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition-all text-sm font-medium disabled:opacity-50"
                                    >
                                        {isGeneratingPdf ? <Icon name="loader" className="w-4 h-4 animate-spin"/> : <Icon name="fileText" className="w-4 h-4" />}
                                        {isGeneratingPdf ? t.common.generating : t.common.downloadFull}
                                    </button>
                                </div>
                            </div>

                            {/* Views */}
                            {activeTab === 'dashboard' && <DashboardView data={processedData} t={t} lang={lang} />}
                            {activeTab === 'growth' && <GrowthView data={processedData} t={t} lang={lang} />}
                            {activeTab === 'margin' && <MarginView data={processedData} t={t} lang={lang} />}

                        </div>
                    </main>

                    {/* Hidden Full Report Container (Only rendered when generating PDF) */}
                    {isGeneratingPdf && (
                        <div ref={fullReportRef} className="pdf-mode">
                            <div className="mb-8 border-b pb-4">
                                <h1 className="text-3xl font-bold text-slate-900">{t.title}</h1>
                                <p className="text-slate-500">{t.subtitle} - {t.footer}</p>
                                <p className="text-sm text-slate-400 mt-1">{new Date().toLocaleDateString()}</p>
                            </div>

                            {/* Section 1 */}
                            <div className="mb-8">
                                <h2 className="text-2xl font-bold text-blue-600 mb-4 border-b border-blue-100 pb-2">{t.tabs.dashboard}</h2>
                                <DashboardView data={processedData} t={t} lang={lang} />
                            </div>

                            {/* Section 2 (Forced Page Break) */}
                            <div className="page-break">
                                <h2 className="text-2xl font-bold text-blue-600 mb-4 border-b border-blue-100 pb-2">{t.tabs.growth}</h2>
                                <GrowthView data={processedData} t={t} lang={lang} />
                            </div>

                            {/* Section 3 (Forced Page Break) */}
                            <div className="page-break">
                                <h2 className="text-2xl font-bold text-blue-600 mb-4 border-b border-blue-100 pb-2">{t.tabs.margin}</h2>
                                <MarginView data={processedData} t={t} lang={lang} />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const NavButton = ({ id, label, icon, active, set }) => (
            <button 
                onClick={() => set(id)}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-left ${
                    active === id 
                    ? 'bg-blue-600 text-white shadow-lg' 
                    : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                }`}
            >
                <Icon name={icon} className="w-5 h-5 flex-shrink-0" />
                <span className="font-medium text-sm">{label}</span>
            </button>
        );

        const KPICard = ({ title, value, subValue, icon, isPositive }) => (
            <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-start justify-between relative overflow-hidden">
                <div className="z-10 relative">
                    <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">{title}</p>
                    <h3 className="text-2xl font-bold text-gray-800">{value}</h3>
                    {subValue && (
                        <div className={`flex items-center gap-1 mt-2 text-xs font-bold ${isPositive ? 'text-green-600' : 'text-red-500'}`}>
                            <span>{isPositive ? '↑' : '↓'}</span>
                            <span>{subValue}</span>
                        </div>
                    )}
                </div>
                <div className={`p-3 rounded-lg flex-shrink-0 ${isPositive === false ? 'bg-red-50 text-red-500' : 'bg-blue-50 text-blue-600'}`}>
                    <Icon name={icon} className="w-6 h-6" />
                </div>
            </div>
        );

        const InsightBox = ({ title, insights }) => (
            <div className="bg-white border-l-4 border-blue-500 shadow-sm rounded-r-xl p-6 mt-8">
                <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <Icon name="dashboard" className="w-5 h-5 text-blue-500" />
                    {title}
                </h4>
                <ul className="space-y-3">
                    {insights.map((insight, idx) => (
                        <li key={idx} className="flex items-start gap-3 text-sm text-slate-600">
                            <span className="w-1.5 h-1.5 rounded-full bg-slate-300 mt-2 flex-shrink-0"></span>
                            {insight}
                        </li>
                    ))}
                </ul>
            </div>
        );

        // --- DASHBOARD VIEW ---
        const DashboardView = ({ data, t, lang }) => {
            const { totals, monthly, clients, recipes } = data;
            
            const salesGrowthPct = totals.sales2024 > 0 ? ((totals.sales2025 - totals.sales2024) / totals.sales2024) * 100 : 0;
            const kgGrowthPct = totals.kg2024 > 0 ? ((totals.kg2025 - totals.kg2024) / totals.kg2024) * 100 : 0;
            const marginDiff = totals.avgMarginPerKg2025 - totals.avgMarginPerKg2024;
            const profitGrowthPct = totals.profit2024 > 0 ? ((totals.profit2025 - totals.profit2024) / totals.profit2024) * 100 : 0;

            const insights = [
                `${t.kpis.growthRevenue}: ${salesGrowthPct.toFixed(1)}% ${t.common.vs} 2024.`,
                `${t.kpis.totalKg}: ${formatNumber(totals.kg2025 - totals.kg2024, lang)} kg (${kgGrowthPct > 0 ? '+' : ''}${kgGrowthPct.toFixed(1)}%).`,
                `${t.kpis.avgMargin}: ${marginDiff >= 0 ? '+' : ''}${formatCurrency(marginDiff, lang)} ${t.common.vs} 2024.`
            ];

            return (
                <div className="animate-fade-in space-y-6">
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <KPICard title={`${t.kpis.totalRevenue} 2025`} value={formatCurrency(totals.sales2025, lang)} subValue={`${salesGrowthPct.toFixed(1)}%`} isPositive={salesGrowthPct > 0} icon="dollar" />
                        <KPICard title={`${t.kpis.totalKg} 2025`} value={`${formatNumber(totals.kg2025, lang)} kg`} subValue={`${kgGrowthPct.toFixed(1)}%`} isPositive={kgGrowthPct > 0} icon="scale" />
                        <KPICard title={t.kpis.avgMargin} value={formatCurrency(totals.avgMarginPerKg2025, lang)} subValue={`${formatCurrency(marginDiff, lang)}`} isPositive={marginDiff >= 0} icon="chart" />
                        <KPICard title={t.kpis.totalProfit} value={formatCurrency(totals.profit2025, lang)} subValue={`${profitGrowthPct.toFixed(1)}%`} isPositive={profitGrowthPct > 0} icon="trendingUp" />
                    </div>

                    <div className="flex flex-col lg:flex-row gap-6">
                        <div className="flex-1 bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 className="font-bold text-gray-700 mb-6 text-sm md:text-base">{t.charts.monthlyRevenue}</h3>
                            <div className="h-72">
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={monthly}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={COLORS.grid} />
                                        <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill: '#64748b', fontSize: 12}} />
                                        <YAxis axisLine={false} tickLine={false} tick={{fill: '#64748b', fontSize: 12}} tickFormatter={(val) => `${val/1000}k`} />
                                        <Tooltip contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}} formatter={(value) => formatCurrency(value, lang)} />
                                        <Legend wrapperStyle={{paddingTop: '10px'}}/>
                                        <Line type="monotone" dataKey="sales2024" name="2024" stroke={COLORS.year2024} strokeWidth={2} dot={{r:3}} />
                                        <Line type="monotone" dataKey="sales2025" name="2025" stroke={COLORS.year2025} strokeWidth={3} dot={{r:4}} />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="w-full lg:w-2/5 bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 className="font-bold text-gray-700 mb-6 text-sm md:text-base">{t.charts.topClients}</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-xs md:text-sm text-left text-gray-500">
                                    <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th className="px-3 py-2 rounded-l-lg">{t.table.client}</th>
                                            <th className="px-3 py-2 text-right">{t.table.sale}</th>
                                            <th className="px-3 py-2 text-right rounded-r-lg">{t.table.growth}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {clients.slice(0, 5).map((client, idx) => {
                                            const growth = client.sales2024 > 0 ? ((client.sales2025 - client.sales2024) / client.sales2024) * 100 : 100;
                                            return (
                                                <tr key={idx} className="border-b hover:bg-gray-50">
                                                    <td className="px-3 py-2 font-medium text-gray-900 truncate max-w-[100px]" title={client.name}>{client.name}</td>
                                                    <td className="px-3 py-2 text-right">{formatCurrency(client.sales2025, lang)}</td>
                                                    <td className={`px-3 py-2 text-right font-bold ${growth >= 0 ? 'text-green-600' : 'text-red-500'}`}>
                                                        {growth >= 0 ? '↑' : '↓'} {Math.abs(growth).toFixed(0)}%
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 className="font-bold text-gray-700 mb-6 text-sm md:text-base">{t.charts.topRecipes}</h3>
                        <div className="h-64">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={recipes.slice(0, 5)}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                    <XAxis dataKey="name" tick={{fontSize: 12}} />
                                    <YAxis tick={{fontSize: 12}} />
                                    <Tooltip formatter={(val) => `${formatNumber(val, lang)} kg`} />
                                    <Legend />
                                    <Bar dataKey="kg2024" name="KG 2024" fill={COLORS.year2024Light} radius={[4, 4, 0, 0]} />
                                    <Bar dataKey="kg2025" name="KG 2025" fill={COLORS.year2025} radius={[4, 4, 0, 0]} />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                    <InsightBox title={t.obs.general} insights={insights} />
                </div>
            );
        };

        // --- GROWTH VIEW ---
        const GrowthView = ({ data, t, lang }) => {
            const { monthly, totals, recipes } = data;
            const quarters = [
                { name: 'Q1', months: [0, 1, 2] }, { name: 'Q2', months: [3, 4, 5] },
                { name: 'Q3', months: [6, 7, 8] }, { name: 'Q4', months: [9, 10, 11] }
            ].map(q => {
                const s24 = q.months.reduce((acc, m) => acc + monthly[m].sales2024, 0);
                const s25 = q.months.reduce((acc, m) => acc + monthly[m].sales2025, 0);
                return { name: q.name, sales2024: s24, sales2025: s25, pct: s24 > 0 ? ((s25 - s24) / s24) * 100 : 0 };
            });

            const topRecipesPie = recipes.slice(0, 5).map(r => ({ name: r.name, value: r.kg2025 }));
            const insights = [`${t.kpis.growthRevenue}: +${formatCurrency(totals.sales2025 - totals.sales2024, lang)}.`];

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-600 flex justify-between items-center">
                            <div>
                                <p className="text-gray-500 text-xs uppercase">{t.kpis.growthRevenue}</p>
                                <h3 className="text-2xl font-bold text-gray-800">+{formatCurrency(totals.sales2025 - totals.sales2024, lang)}</h3>
                            </div>
                            <span className="bg-blue-100 text-blue-800 text-sm font-bold px-2.5 py-1 rounded">
                                +{totals.sales2024 > 0 ? ((totals.sales2025 - totals.sales2024)/totals.sales2024 * 100).toFixed(1) : 0}%
                            </span>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-600 flex justify-between items-center">
                            <div>
                                <p className="text-gray-500 text-xs uppercase">{t.kpis.growthVol}</p>
                                <h3 className="text-2xl font-bold text-gray-800">+{formatNumber(totals.kg2025 - totals.kg2024, lang)} kg</h3>
                            </div>
                            <span className="bg-purple-100 text-purple-800 text-sm font-bold px-2.5 py-1 rounded">
                                +{totals.kg2024 > 0 ? ((totals.kg2025 - totals.kg2024)/totals.kg2024 * 100).toFixed(1) : 0}%
                            </span>
                        </div>
                    </div>

                    <div className="flex flex-col lg:flex-row gap-6">
                        <div className="flex-1 bg-white p-6 rounded-xl shadow-sm">
                            <h3 className="font-bold text-gray-700 mb-4 text-sm md:text-base">{t.charts.monthlyComp}</h3>
                            <div className="h-64">
                                <ResponsiveContainer>
                                    <BarChart data={monthly}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                        <XAxis dataKey="name" tick={{fontSize: 12}} />
                                        <YAxis tickFormatter={(val) => `${val/1000}k`} tick={{fontSize: 12}} />
                                        <Tooltip formatter={(val) => formatCurrency(val, lang)} />
                                        <Bar dataKey="sales2024" fill={COLORS.year2024} radius={[2,2,0,0]} />
                                        <Bar dataKey="sales2025" fill={COLORS.year2025} radius={[2,2,0,0]} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                        <div className="flex-1 bg-white p-6 rounded-xl shadow-sm">
                            <h3 className="font-bold text-gray-700 mb-4 text-sm md:text-base">{t.charts.quarterly}</h3>
                            <table className="w-full text-xs md:text-sm">
                                <thead className="bg-gray-50 text-gray-600">
                                    <tr>
                                        <th className="px-3 py-2 text-left">{t.table.q}</th>
                                        <th className="px-3 py-2 text-right">2024</th>
                                        <th className="px-3 py-2 text-right">2025</th>
                                        <th className="px-3 py-2 text-right">{t.table.change}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {quarters.map((q, i) => (
                                        <tr key={i} className="border-b">
                                            <td className="px-3 py-2 font-medium">{q.name}</td>
                                            <td className="px-3 py-2 text-right">{formatCurrency(q.sales2024, lang)}</td>
                                            <td className="px-3 py-2 text-right">{formatCurrency(q.sales2025, lang)}</td>
                                            <td className={`px-3 py-2 text-right font-bold ${q.pct >=0 ? 'text-green-600':'text-red-500'}`}>{q.pct.toFixed(1)}%</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <InsightBox title={t.obs.growth} insights={insights} />
                </div>
            );
        };

        // --- MARGIN VIEW (UPDATED CHART) ---
        const MarginView = ({ data, t, lang }) => {
            const { monthly, totals, recipes } = data;
            const [selectedYear, setSelectedYear] = useState('2025'); // State for chart toggle
            
            const marginChange = totals.avgMarginPerKg2025 - totals.avgMarginPerKg2024;
            const marginPctChange = totals.marginPct2025 - totals.marginPct2024;
            const insights = [`${t.kpis.avgMargin}: ${formatCurrency(totals.avgMarginPerKg2025, lang)}.`];

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <KPICard title={`${t.kpis.avgMargin} 2025`} value={formatCurrency(totals.avgMarginPerKg2025, lang)} subValue={formatCurrency(marginChange, lang)} isPositive={marginChange >= 0} icon="dollar" />
                        <KPICard title={`${t.kpis.marginPct} 2025`} value={`${totals.marginPct2025.toFixed(1)}%`} subValue={`${marginPctChange.toFixed(1)}%`} isPositive={marginPctChange >= 0} icon="chart" />
                        <KPICard title={`${t.kpis.totalProfit} 2025`} value={formatCurrency(totals.profit2025, lang)} subValue="2025" isPositive={true} icon="trendingUp" />
                    </div>

                    {/* UPDATED CHART WITH YEAR SELECTOR */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 relative">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-gray-700 text-sm md:text-base">{t.charts.priceVsCost}</h3>
                            <div className="flex bg-gray-100 rounded-lg p-1">
                                <button onClick={() => setSelectedYear('2024')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${selectedYear === '2024' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>2024</button>
                                <button onClick={() => setSelectedYear('2025')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${selectedYear === '2025' ? 'bg-white shadow text-purple-600' : 'text-gray-500'}`}>2025</button>
                            </div>
                        </div>
                        
                        <div className="h-80">
                            <ResponsiveContainer>
                                <AreaChart data={monthly}>
                                    <defs>
                                        <linearGradient id="marginGradient" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor={selectedYear === '2025' ? COLORS.year2025 : COLORS.year2024} stopOpacity={0.2}/>
                                            <stop offset="95%" stopColor={selectedYear === '2025' ? COLORS.year2025 : COLORS.year2024} stopOpacity={0}/>
                                        </linearGradient>
                                    </defs>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                    <XAxis dataKey="name" tick={{fontSize: 12}} />
                                    <YAxis tickFormatter={(val) => `$${val}`} tick={{fontSize: 12}} />
                                    <Tooltip formatter={(val) => formatCurrency(val, lang)} />
                                    <Legend />
                                    {/* Cost Line (Base) */}
                                    <Area 
                                        type="monotone" 
                                        dataKey={`avgCost${selectedYear}`} 
                                        name={`${t.common.cost} ${selectedYear}`} 
                                        stackId="1" 
                                        stroke="#ef4444" 
                                        fill="transparent" 
                                        strokeWidth={2}
                                        strokeDasharray="5 5"
                                    />
                                    {/* Price Line */}
                                    <Area 
                                        type="monotone" 
                                        dataKey={`avgPrice${selectedYear}`} 
                                        name={`${t.common.price} ${selectedYear}`} 
                                        stroke={selectedYear === '2025' ? COLORS.year2025 : COLORS.year2024} 
                                        fill="url(#marginGradient)" 
                                        strokeWidth={3}
                                    />
                                </AreaChart>
                            </ResponsiveContainer>
                        </div>
                        <p className="text-xs text-center text-gray-400 mt-2">
                            * {t.common.cost} (---) {t.common.vs} {t.common.price} (___)
                        </p>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-sm overflow-x-auto">
                        <h3 className="font-bold text-gray-700 mb-4 text-sm md:text-base">{t.charts.profitComp}</h3>
                        <table className="w-full text-xs md:text-sm text-left">
                            <thead className="bg-slate-50 text-slate-600 uppercase text-xs">
                                <tr>
                                    <th className="px-4 py-3">{t.table.concept}</th>
                                    <th className="px-4 py-3 text-right">{t.table.price}</th>
                                    <th className="px-4 py-3 text-right">{t.table.cost}</th>
                                    <th className="px-4 py-3 text-right">{t.table.margin}</th>
                                    <th className="px-4 py-3 text-right">{t.table.marginPct}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr className="border-b">
                                    <td className="px-4 py-3 font-medium text-blue-600">2024</td>
                                    <td className="px-4 py-3 text-right">{formatCurrency(totals.kg2024 > 0 ? totals.sales2024 / totals.kg2024 : 0, lang)}</td>
                                    <td className="px-4 py-3 text-right">{formatCurrency(totals.kg2024 > 0 ? (totals.sales2024 - totals.profit2024)/totals.kg2024 : 0, lang)}</td>
                                    <td className="px-4 py-3 text-right">{formatCurrency(totals.avgMarginPerKg2024, lang)}</td>
                                    <td className="px-4 py-3 text-right">{totals.marginPct2024.toFixed(1)}%</td>
                                </tr>
                                <tr className="border-b bg-purple-50">
                                    <td className="px-4 py-3 font-medium text-purple-700">2025</td>
                                    <td className="px-4 py-3 text-right">{formatCurrency(totals.kg2025 > 0 ? totals.sales2025 / totals.kg2025 : 0, lang)}</td>
                                    <td className="px-4 py-3 text-right">{formatCurrency(totals.kg2025 > 0 ? (totals.sales2025 - totals.profit2025)/totals.kg2025 : 0, lang)}</td>
                                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(totals.avgMarginPerKg2025, lang)}</td>
                                    <td className="px-4 py-3 text-right font-bold">{totals.marginPct2025.toFixed(1)}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <InsightBox title={t.obs.margin} insights={insights} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
